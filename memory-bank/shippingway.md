# 配送方法判定ロジック

## 概要
本システムでは、カート内の商品構成や手動入力されたサイズに基づき、利用可能な配送キャリア（配送方法）を価格の安い順に評価し、最適なプランを提案します。

## 処理フロー

### 1. 入力データの準備 (`ShippingController`)
- **カート計算 (`/calculate/cart`)**
    - リクエストに含まれる商品IDと数量を基に商品情報を取得。
    - 数量指定がある商品は、その数だけ個別のアイテムとしてリストに展開します（例：商品A×2 → [商品A, 商品A]）。
- **手動計算 (`/calculate/manual`)**
    - 入力されたサイズ・重量を持つ単一の「仮想商品」を作成して処理します。

### 2. 梱包サイズの計算 (`PackingService`)
- 展開された商品リストを基に、商品全体を梱包した際の概算サイズ（Dimensions）を算出します。
- これにより、配送前の「荷姿」をシミュレーションします。

### 3. 最適な配送方法の選定 (`ShippingMatcher`)
`findBestOptions` メソッドにより、以下の手順で判定が行われます。

1.  **配送キャリアの取得**
    - 登録されている全ての配送方法を**価格の安い順**（昇順）で取得します。

2.  **適合判定（ループ処理）**
    - 安い配送方法から順に、以下の条件でチェックを行います。
    - **`packingService.canFit(items, carrier)`**:
        - 商品構成がその配送方法の制限（最大サイズ、重量、3辺合計など）に収まるか。
        - 3Dパッキングアルゴリズムにより、物理的に箱に収まるか。

3.  **結果の分類**
    - **適合する場合**:
        - 結果リストに追加されます。
        - **最初に適合した（＝最も安い）配送方法**が「推奨 (Recommended)」フラグが立ちます。
    - **適合しない場合**:
        - 不適合リスト (`notFitting`) に追加され、後で理由の説明に使用されます。

### 4. 判定理由の生成

#### 推奨プランへの理由付与
推奨された（最安の）配送方法には、それよりさらに安い配送方法が**なぜ選ばれなかったか**の説明が付与されます。

**不適合理由の優先順位（判定ロジック）**:
推奨プランより安い候補の中で、最も価格が高いもの（＝惜しかった候補）と比較し、以下の順でNG理由を表示します。

1.  **厚さ超過**: 荷物の高さ > 制限高さ
2.  **長さ超過**: 荷物の長さ > 制限長さ
3.  **幅超過**: 荷物の幅 > 制限幅
4.  **重量超過**: 荷物の重量 > 制限重量
5.  **サイズ超過**: 3辺合計 > 制限合計
6.  **形状不適合**: 上記数値内だが、3Dパッキングで収まらない場合（「形状的に箱に入りません」）

#### その他の適合プラン
推奨プラン以外で適合する配送方法には、単純なサイズ説明（例：「60サイズ対応」「3辺合計 80cm」など）が表示されます。

## 配送マスタデータ (価格順)

システムは以下の優先順位（価格が安い順）で適合チェックを行います。
上位から順に条件を満たすものが推奨されます。

| 順位 | 配送サービス名 | 価格 (円) | 最大サイズ (cm) <br> (長辺 × 短辺 × 厚さ) | 重量制限 | その他制限 | 特記事項 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | 定形郵便 (50g以内) | 110 | 23.5 × 12.0 × 1.0 | 50g | - | 長形3号封筒 |
| 2 | 定形外郵便 (規格内 50g) | 140 | 34.0 × 25.0 × 3.0 | 50g | - | - |
| 3 | ゆうパケットポストmini | 160 | 21.0 × 17.0 × 3.0 | 2kg | - | 専用封筒 |
| 4 | 定形外郵便 (規格内 100g) | 180 | 34.0 × 25.0 × 3.0 | 100g | - | - |
| 5 | クリックポスト | 185 | 34.0 × 25.0 × 3.0 | 1kg | - | ネット決済 |
| 6 | スマートレター | 210 | 25.0 × 17.0 × 2.0 | 1kg | - | A5サイズ |
| 7 | ネコポス | 210 | 31.2 × 22.8 × 3.0 | 1kg | - | A4サイズ |
| 8 | ゆうパケットポスト | 215 | 34.0 × 23.0 × 4.0 | 2kg | 3辺60cm | シール利用 |
| 9 | ゆうパケット | 230 | 34.0 × 23.0 × 3.0 | 1kg | 3辺60cm | - |
| 10 | 定形外郵便 (規格内 150g) | 270 | 34.0 × 25.0 × 3.0 | 150g | - | - |
| 11 | レターパックライト | 430 | 34.0 × 24.8 × 3.0 | 4kg | - | A4サイズ |
| 12 | 宅急便コンパクト (専用/薄型) | 450 | 25.0 × 20.0 × 5.0 | - | - | 専用BOX |
| 13 | ゆうパケットプラス | 455 | 24.0 × 17.0 × 7.0 | 2kg | - | 専用BOX |
| 14 | レターパックプラス | 600 | 34.0 × 24.8 × 7.0 | 4kg | - | 封筒に入るまで (厚さ7cm確定) |
| 15 | 宅急便 60サイズ | 750 | 60 × 60 × 60 | 2kg | 3辺計 60cm | - |
| 16 | ゆうパック 60サイズ | 770 | 60 × 60 × 60 | 25kg | 3辺計 60cm | - |
| 17 | 宅急便 80サイズ | 850 | 80 × 80 × 80 | 5kg | 3辺計 80cm | - |
| 18 | ゆうパック 80サイズ | 870 | 80 × 80 × 80 | 25kg | 3辺計 80cm | - |
| 19 | 宅急便 100サイズ | 1,050 | 100 × 100 × 100 | 10kg | 3辺計 100cm | - |
| 20 | ゆうパック 100サイズ | 1,070 | 100 × 100 × 100 | 25kg | 3辺計 100cm | - |
| 21 | 宅急便 120サイズ | 1,200 | 120 × 120 × 120 | 15kg | 3辺計 120cm | - |
| 22 | ゆうパック 120サイズ | 1,200 | 120 × 120 × 120 | 25kg | 3辺計 120cm | - |
| 23 | 宅急便 140サイズ | 1,450 | 140 × 140 × 140 | 20kg | 3辺計 140cm | - |
| 24 | ゆうパック 140サイズ | 1,450 | 140 × 140 × 140 | 25kg | 3辺計 140cm | - |
| 25 | 宅急便 160サイズ | 1,700 | 160 × 160 × 160 | 25kg | 3辺計 160cm | - |
| 26 | ゆうパック 160サイズ | 1,700 | 160 × 160 × 160 | 25kg | 3辺計 160cm | - |
| 27 | ゆうパック 170サイズ | 1,900 | 170 × 170 × 170 | 25kg | 3辺計 170cm | - |
| 28 | 宅急便 180サイズ | 2,100 | 180 × 180 × 180 | 30kg | 3辺計 180cm | 集荷不可 |
| 29 | 宅急便 200サイズ | 2,500 | 200 × 200 × 200 | 30kg | 3辺計 200cm | 集荷不可 |

## 関連クラス
- `com.smartship.controller.ShippingController`: リクエストの受け付けとデータ展開
- `com.smartship.service.ShippingMatcher`: 価格順の比較と推奨ロジック
- `com.smartship.service.PackingService`: 3Dパッキングとサイズ計算

## 付録: 標準商品データ (マスタの一部)
システムの検証・テスト用に登録されている主な商品カテゴリとサイズ定義は以下の通りです。
特に「Hobbies」カテゴリは、メルカリ等で取引の多いアイテムを基準に設定されています。

| カテゴリ | 商品名 | サイズ (cm) | 重量 (g) | 備考 |
| :--- | :--- | :--- | :--- | :--- |
| **Hobbies** | Prize Figure (Boxed) | 18.0 × 12.0 × 9.0 | 350g | 一般的なプライズフィギュア |
| **Hobbies** | Scale Figure (Boxed) | 25.0 × 20.0 × 15.0 | 800g | 大型・高額フィギュア |
| **Hobbies** | Plush Toy (Standard) | 30.0 × 20.0 × 15.0 | 300g | 中型ぬいぐるみ |
| **Hobbies** | Mascot Plush (Chibigurumi) | 11.0 × 8.0 × 5.0 | 40g | ちびぐるみ (圧縮可) |
| **Fashion** | Kids Clothing (Set) | 20.0 × 15.0 × 3.0 | 150g | 子供服セット |
| **Electronics** | Smartphone (In Box) | 16.0 × 9.0 × 5.0 | 400g | 箱入りスマホ |

